<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚≠ê Premium Requests - Trader Route</title>
  <link rel="icon" href="assets/logos.png" type="image/png" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- ===== HEADER ===== -->
  <header>
    <div class="logo-container" onclick="location.href='index.html'">
      <img src="assets/logos.png" alt="Trader Route Logo" loading="lazy" />
      <span class="logo-text">The Silk Road of E-Commerce</span>
    </div>

    <nav>
      <a href="index.html">Home</a>
      <a href="companies.html">Companies</a>
      <a href="requests.html">Requests</a>
      <a href="contact.html">Contact</a>
      <a href="pricing.html">Pricing</a>
    </nav>

    <div class="header-right">
      <div class="search-box">
        <input type="text" placeholder="Search..." />
        <button>üîç</button>
      </div>

      <div id="messageIconContainer" style="position:relative;margin-left:15px;">
        <a href="messages.html" id="messageIconLink" style="text-decoration:none;color:inherit;">
          <img src="assets/email.png" alt="Messages" style="width:25px;height:25px;cursor:pointer;">
          <span id="messageBadge"
                style="position:absolute;top:-5px;right:-8px;background:red;color:white;font-size:11px;border-radius:50%;padding:2px 5px;display:none;">
          </span>
        </a>
      </div>

      <button class="login-btn" onclick="location.href='login.html'">Sign In</button>
      <button class="join-btn" onclick="location.href='register.html'">Join Now</button>

      <img id="userIcon" src="assets/user-icon.png" alt="User Icon"
           style="width:36px;height:36px;border-radius:50%;cursor:pointer;display:none;">
      <div id="userDropdown"
           style="display:none;position:absolute;right:0;top:45px;background:#fff;border:1px solid #ddd;border-radius:8px;
                  box-shadow:0 6px 18px rgba(0,0,0,.12);width:180px;z-index:999;overflow:hidden;">
        <a href="profile.html" style="display:block;padding:10px 12px;color:#333;text-decoration:none;border-bottom:1px solid #eee;">Profile</a>
        <a href="messages.html" style="display:block;padding:10px 12px;color:#333;text-decoration:none;border-bottom:1px solid #eee;">Messages</a>
        <a href="#" onclick="logoutUser()" style="display:block;padding:10px 12px;color:#d9534f;text-decoration:none;">Logout</a>
      </div>
    </div>
  </header>

  <!-- ===== TABS (requests ile aynƒ±) ===== -->
  <div class="tabs">
    <button class="active" id="tabAll">All Requests</button>
    <button id="tabBuy">Buy Requests</button>
    <button id="tabSell">Sell Requests</button>
    <button id="tabFree" onclick="location.href='request-form.html'">Free Request</button>
  </div>

  <!-- ===== LAYOUT ===== -->
  <div class="container">
    <div class="sidebar">
      <h4>Categories</h4>
      <input type="text" id="categorySearch" placeholder="Search category">
      <ul id="categoryList"></ul>

      <h4>Countries</h4>
      <input type="text" id="countrySearch" placeholder="Search country">
      <ul id="countryList"></ul>
    </div>

    <div class="content">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search requests...">
      </div>
      <div id="requestItems"></div>
    </div>
  </div>

  <!-- ===== JS ===== -->
  <script src="assets/flag.js"></script>

  <script>
    let categories = null, allCountries = null;
    const requestContainer = document.getElementById("requestItems"),
          searchInput = document.getElementById("searchInput"),
          categoryList = document.getElementById("categoryList"),
          countryList = document.getElementById("countryList"),
          categorySearch = document.getElementById("categorySearch"),
          countrySearch = document.getElementById("countrySearch");

    let activeTab = "all", selectedCategory = null, selectedCountry = null;
    let allRequestsData = [];

    async function getRequests() {
      try {
        const res = await fetch("https://api.traderroute.com/requests?t=" + Date.now());
        if (!res.ok) return [];
        const data = await res.json();
        return Array.isArray(data) ? data : (data.record || data.data || []);
      } catch (e) { return []; }
    }

    async function ensureCategories() {
      if (categories) return;
      try {
        const r = await fetch("data/categories.json");
        categories = await r.json();
      } catch { categories = []; }
    }

    async function ensureCountries() {
      if (allCountries) return;
      try {
        const r = await fetch("data/countries.json");
        const a = await r.json();
        allCountries = a.map(it => ({
          name: it.name || it,
          code: (it.code || "").toLowerCase()
        }));
      } catch { allCountries = []; }
    }

    function renderCategories(reqs) {
      const term = (categorySearch.value || "").toLowerCase();
      const filtered = (categories || []).filter(c => c.toLowerCase().includes(term));
      categoryList.innerHTML = "";
      filtered.forEach(cat => {
        const count = reqs.filter(r => r.category === cat).length;
        const li = document.createElement("li");
        li.innerHTML = `<a href="#">${cat} <span class="count">(${count})</span></a>`;
        li.onclick = e => { e.preventDefault(); selectedCategory = cat; selectedCountry = null; renderRequests(); };
        categoryList.appendChild(li);
      });
    }

    function renderCountries(reqs) {
      const term = (countrySearch.value || "").toLowerCase();
      const filtered = (allCountries || []).filter(c => c.name.toLowerCase().includes(term));
      countryList.innerHTML = "";
      filtered.forEach(c => {
        const count = reqs.filter(r => r.country === c.name).length;
        const flagImg = getFlagURL(c.name, 20);
        const li = document.createElement("li");
        li.innerHTML = `<a href="#"><span style="display:flex;align-items:center;gap:6px;">
            <img class='flag' src='${flagImg}' alt='${c.name}' loading='lazy'>${c.name}</span>
            <span class='count'>(${count})</span></a>`;
        li.onclick = e => { e.preventDefault(); selectedCountry = c.name; selectedCategory = null; renderRequests(); };
        countryList.appendChild(li);
      });
    }

    function renderRequests(data) {
      if (data) allRequestsData = data;
      const all = allRequestsData || [];
      const today = new Date();

      const filtered = all.filter(r => 
        r.isPremium && r.premiumUntil && new Date(r.premiumUntil) >= today &&
        (activeTab === "all" || r.type === activeTab) &&
        (!selectedCategory || r.category === selectedCategory) &&
        (!selectedCountry || r.country === selectedCountry) &&
        ((r.title || "").toLowerCase().includes((searchInput.value || "").toLowerCase()) ||
         (r.description || "").toLowerCase().includes((searchInput.value || "").toLowerCase()))
      ).sort((a, b) => new Date(b.date) - new Date(a.date));

      renderCategories(filtered);
      renderCountries(filtered);

      requestContainer.innerHTML = "";
      if (!filtered.length) {
        requestContainer.innerHTML = `<p style="text-align:center;color:#999;">No active premium requests found.</p>`;
        return;
      }

      filtered.forEach(r => {
        const owner = r.ownerEmail || r.contactEmail || r.email || "";
        const div = document.createElement("div");
        div.className = "request-card";
        div.style.border = "2px solid #FFD700";
        div.style.background = "#fffbe6";
        div.style.cursor = "pointer";
        div.onclick = () => window.location.href = `request-detail.html?id=${encodeURIComponent(r.id)}&to=${encodeURIComponent(owner)}`;

        const flagImg = `<img src="${getFlagURL(r.country, 20)}" alt="${r.country}" class="flag-icon-img"
            onerror="this.src='assets/flag/default.png'" style="margin-right:6px;">`;
        div.innerHTML = `
          <h5>${r.title || "Untitled Request"} 
            <span style="background:#FFD700;color:#000;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700;margin-left:8px;">‚≠ê Premium</span>
          </h5>
          <p>${r.description || ""}</p>
          <small>${flagImg}${r.country || "Unknown"} ¬∑ ${r.category || ""} ¬∑ ${new Date(r.date).toLocaleDateString('tr-TR')}</small>
        `;
        requestContainer.appendChild(div);
      });
    }

    document.getElementById("tabAll").onclick = () => { activeTab = "all"; renderRequests(); };
    document.getElementById("tabBuy").onclick = () => { activeTab = "buy"; renderRequests(); };
    document.getElementById("tabSell").onclick = () => { activeTab = "sell"; renderRequests(); };
    searchInput.addEventListener("input", () => renderRequests());

    (async function init() {
      await Promise.all([ensureCategories(), ensureCountries()]);
      const data = await getRequests();
      renderRequests(data);
    })();
  </script>

  <!-- USER MENU & MESSAGE BADGE -->
  <script>
    (function(){
      const icon=document.getElementById("userIcon");
      const dropdown=document.getElementById("userDropdown");
      const loginBtn=document.querySelector("button[onclick*='login.html']");
      const joinBtn=document.querySelector("button[onclick*='register.html']");
      const currentUser=JSON.parse(localStorage.getItem("tr_user")||"null");
      if(currentUser){ icon.style.display="inline-block"; loginBtn.style.display="none"; joinBtn.style.display="none"; }
      else { icon.style.display="none"; }
      icon?.addEventListener("click",e=>{e.stopPropagation();dropdown.style.display=(dropdown.style.display==="block")?"none":"block";});
      document.addEventListener("click",e=>{if(!e.target.closest("#userDropdown")&&e.target.id!=="userIcon")dropdown.style.display="none";});
      window.logoutUser=function(){localStorage.removeItem("tr_user");location.href="index.html";}
    })();

    (function(){
      const badge=document.getElementById("messageBadge");
      const user=JSON.parse(localStorage.getItem("tr_user")||"null");
      if(!user||!badge)return;
      const allMessages=JSON.parse(localStorage.getItem("tr_messages")||"[]");
      const unread=allMessages.filter(m=>m.to===user.email&&!m.read);
      badge.textContent=unread.length||"";
      badge.style.display=unread.length>0?"inline-block":"none";
    })();
  </script>

</body>
</html>
