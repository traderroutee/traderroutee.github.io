<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Premium Requests ‚Äî Trader Route</title>
  <link rel="icon" href="assets/logos.png" type="image/png">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- HEADER (deƒüi≈ütirmedik) -->
  <header>
    <div class="logo-container" onclick="location.href='index.html'">
      <img src="assets/logos.png" alt="Trader Route Logo" loading="lazy">
      <span class="logo-text">The Silk Road of E-Commerce</span>
    </div>

    <nav>
      <a href="index.html">Home</a>
      <a href="companies.html">Companies</a>
      <a href="requests.html">Requests</a>
      <a href="contact.html">Contact</a>
      <a href="pricing.html">Pricing</a>
    </nav>

    <div class="header-right">
      <div class="search-box">
        <input type="text" placeholder="Search...">
        <button>üîç</button>
      </div>

      <div id="messageIconContainer" style="position:relative;margin-left:15px;">
        <a href="messages.html" id="messageIconLink" style="text-decoration:none;color:inherit;">
          <img src="assets/email.png" alt="Messages" style="width:25px;height:25px;cursor:pointer;">
          <span id="messageBadge" style="position:absolute;top:-5px;right:-8px;background:red;color:white;font-size:11px;border-radius:50%;padding:2px 5px;display:none;"></span>
        </a>
      </div>

      <button class="login-btn" onclick="location.href='login.html'">Sign In</button>
      <button class="join-btn" onclick="location.href='register.html'">Join Now</button>

      <img id="userIcon" src="assets/user-icon.png" alt="User Icon" style="width:36px;height:36px;border-radius:50%;cursor:pointer;display:none;">
      <div id="userDropdown" style="display:none;position:absolute;right:0;top:45px;background:#fff;border:1px solid #ddd;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.12);width:180px;z-index:999;overflow:hidden;">
        <a href="profile.html" style="display:block;padding:10px 12px;color:#333;text-decoration:none;border-bottom:1px solid #eee;">Profile</a>
        <a href="messages.html" style="display:block;padding:10px 12px;color:#333;text-decoration:none;border-bottom:1px solid #eee;">Messages</a>
        <a href="#" onclick="logoutUser()" style="display:block;padding:10px 12px;color:#d9534f;text-decoration:none;">Logout</a>
      </div>
    </div>
  </header>

  <!-- === TABS (requests sayfasƒ± ile aynƒ± g√∂r√ºn√ºm) === -->
  <div class="tabs">
    <button class="active" id="tabAll">All Requests</button>
    <button id="tabBuy">Buy Requests</button>
    <button id="tabSell">Sell Requests</button>
    <button id="tabFree" onclick="location.href='request-form.html'">Free Request</button>
  </div> <!-- tabs -->
  <!-- (Sekmeler sadece premium altƒ±ndaki type filtrelemesini yapacak) --> :contentReference[oaicite:2]{index=2}

  <!-- === LAYOUT (sol filtreler + i√ßerik) === -->
  <div class="container">
    <div class="sidebar">
      <h4>Categories</h4>
      <input type="text" class="category-search" id="categorySearch" placeholder="Search category.">
      <ul class="category-list" id="categoryList"></ul>

      <h4>Countries</h4>
      <input type="text" class="country-search" id="countrySearch" placeholder="Search country.">
      <ul class="country-list" id="countryList"></ul>
    </div>

    <div class="content">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search requests.">
      </div>
      <div id="requestItems"></div>
    </div>
  </div> <!-- container --> :contentReference[oaicite:3]{index=3}

  <!-- === JS === -->
  <script src="assets/flag.js"></script>

  <script>
    // requests.html‚Äôdekiyle aynƒ± deƒüi≈üken seti (ID‚Äôler birebir) :contentReference[oaicite:4]{index=4}
    let categories=null, allCountries=null;

    async function getRequests() {
      try {
        const res = await fetch("https://api.traderroute.com/requests?t=" + Date.now());
        if (res.ok) {
          const data = await res.json();
          return Array.isArray(data) ? data : [];
        }
        return [];
      } catch (e) { return []; }
    } :contentReference[oaicite:5]{index=5}

    const requestContainer=document.getElementById("requestItems"),
          searchInput=document.getElementById("searchInput"),
          categoryList=document.getElementById("categoryList"),
          countryList=document.getElementById("countryList"),
          categorySearch=document.getElementById("categorySearch"),
          countrySearch=document.getElementById("countrySearch");

    // Premium sayfasƒ±: varsayƒ±lan sekme "all", ama sadece premium g√∂sterilecek
    let activeTab="all", selectedCategory=null, selectedCountry=null;

    // Countries & categories helper‚Äôlarƒ± (requests.html ile aynƒ± mantƒ±k) :contentReference[oaicite:6]{index=6}
    function toCode(name){ if(!name) return "unknown"; const key=Object.keys(countryCodeMap).find(k=>k.toLowerCase()===name.toLowerCase()); if(key) return countryCodeMap[key]; return (name.slice(0,2)||"unknown").toLowerCase(); }

    async function ensureCategories(){ if(categories) return; try{ const r=await fetch("data/categories.json",{cache:"no-store"}); categories=await r.json(); }catch{ categories=[]; } }
    async function ensureCountries(){ if(allCountries) return; try{ const r=await fetch("data/countries.json",{cache:"no-store"}); const a=await r.json(); allCountries=a.map(it=>({name:it.name||it,code:(it.code||countryCodeMap[it.name||it]||toCode(it.name||it)).toLowerCase()})); }catch{ allCountries=[]; } } :contentReference[oaicite:7]{index=7}

    function renderCountries(reqs){
      const t=(countrySearch.value||"").toLowerCase();
      const d=(allCountries||[]).filter(c=>c.name.toLowerCase().includes(t));
      countryList.innerHTML="";
      d.forEach(c=>{
        const n=reqs.filter(r=>r.country===c.name).length;
        const flagImg=getFlagURL(c.name,20);
        const li=document.createElement("li");
        li.innerHTML=`<a href="#"><span style="display:flex;align-items:center;gap:6px;"><img class='flag' src='${flagImg}' alt='${c.name}' loading='lazy'>${c.name}</span><span class='count'>(${n})</span></a>`;
        li.onclick=e=>{e.preventDefault(); selectedCountry=c.name; selectedCategory=null; renderRequests();};
        countryList.appendChild(li);
      });
    } :contentReference[oaicite:8]{index=8}

    function renderCategories(reqs){
      const t=(categorySearch.value||"").toLowerCase();
      const d=(categories||[]).filter(c=>c.toLowerCase().includes(t));
      categoryList.innerHTML="";
      d.forEach(cat=>{
        const c=reqs.filter(r=>r.category===cat).length;
        const li=document.createElement("li");
        li.innerHTML=`<a href="#"><span>${cat}</span><span class="count">(${c})</span></a>`;
        li.onclick=e=>{e.preventDefault(); selectedCategory=cat; selectedCountry=null; renderRequests();};
        categoryList.appendChild(li);
      });
    } :contentReference[oaicite:9]{index=9}

    let allRequestsData=[];

    function renderRequests(allData){
      if(allData) allRequestsData=allData;
      const all=allRequestsData||[];

      // Sidebar sayacƒ± ve listeleri, sadece PREMIUM veri √ºzerinden hesaplƒ±yoruz
      const today=new Date();
      const isPremiumOk = r => r.isPremium && r.premiumUntil && new Date(r.premiumUntil) >= today;

      // Sadece premium olanlarƒ± baz al
      const premiumAll = all.filter(r =>
        isPremiumOk(r) &&
        (activeTab==="all" || r.type===activeTab) &&
        (!selectedCategory || r.category===selectedCategory) &&
        (!selectedCountry || r.country===selectedCountry) &&
        ((r.title||"").toLowerCase().includes((searchInput.value||"").toLowerCase()) ||
         (r.description||"").toLowerCase().includes((searchInput.value||"").toLowerCase()))
      ).sort((a,b)=>new Date(b.date)-new Date(a.date));

      // Filtre listelerini premium datasƒ±na g√∂re kur
      renderCategories(premiumAll);
      renderCountries(premiumAll);

      // Listeyi bas
      requestContainer.innerHTML="";
      if(premiumAll.length===0){
        const p=document.createElement("p");
        p.style.cssText="text-align:center;color:#999;margin:20px 0";
        p.textContent="No active premium requests found.";
        requestContainer.appendChild(p);
        return;
      }

      premiumAll.forEach(r=>{
        const owner=r.ownerEmail||r.contactEmail||r.email||"";
        const div=document.createElement("div");
        div.className="request-card";
        div.style.border="2px solid #FFD700";
        div.style.background="#fffbe6";
        div.style.cursor="pointer";
        div.onclick=()=>window.location.href=`request-detail.html?id=${encodeURIComponent(r.id)}&to=${encodeURIComponent(owner)}`;

        const flagImg=`<img src="${getFlagURL(r.country,20)}" alt="${r.country}" class="flag-icon-img" onerror="this.onerror=null;this.src='assets/flag/default.png'">`;
        div.innerHTML=`
          <h5>${r.title || "Untitled Request"} <span style="background:#FFD700;color:#000;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700;margin-left:8px;">‚≠ê Premium</span></h5>
          <p>${r.description || ""}</p>
          <small>${flagImg}${r.country || "Unknown"} ¬∑ ${r.category || ""} ¬∑ ${new Date(r.date).toLocaleDateString('tr-TR')}</small>
        `;
        requestContainer.appendChild(div);
      });
    } :contentReference[oaicite:10]{index=10}

    // Sekmeler (type filtresi ‚Äî yalnƒ±z premium i√ßinde √ßalƒ±≈üƒ±r)
    function setActive(id){
      document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }
    document.getElementById("tabAll").onclick = ()=>{activeTab='all'; setActive("tabAll"); renderRequests();};
    document.getElementById("tabBuy").onclick = ()=>{activeTab='buy'; setActive("tabBuy"); renderRequests();};
    document.getElementById("tabSell").onclick = ()=>{activeTab='sell'; setActive("tabSell"); renderRequests();};

    // Arama alanƒ±
    searchInput.addEventListener("input", ()=>renderRequests());

    // ƒ∞lk y√ºkleme
    (async function init(){
      await Promise.all([ensureCategories(), ensureCountries()]);
      const data = await getRequests();
      renderRequests(data);
    })();
  </script>

  <!-- USER MENU & MESSAGE BADGE (mevcut sayfalarla aynƒ±) -->
  <script>
    (function(){
      const header=document.querySelector("header");
      const icon=document.getElementById("userIcon");
      const dropdown=document.getElementById("userDropdown");
      const loginBtn=header?.querySelector("button[onclick*='login.html']");
      const joinBtn=header?.querySelector("button[onclick*='register.html']");
      const currentUser=JSON.parse(localStorage.getItem("tr_user")||"null");
      if(currentUser){ if(icon) icon.style.display="inline-block"; if(loginBtn) loginBtn.style.display="none"; if(joinBtn) joinBtn.style.display="none"; }
      else { if(icon) icon.style.display="none"; }
      icon?.addEventListener("click", e=>{ e.stopPropagation(); dropdown.style.display=(dropdown.style.display==="block")?"none":"block"; });
      document.addEventListener("click", e=>{ if(!e.target.closest("#userDropdown") && e.target.id!=="userIcon") dropdown.style.display="none"; });
      window.logoutUser=function(){ localStorage.removeItem("tr_user"); location.href="index.html"; };
    })();

    (function(){
      const badge=document.getElementById("messageBadge");
      const user=JSON.parse(localStorage.getItem("tr_user")||"null");
      if(!user || !badge) return;
      const allMessages=JSON.parse(localStorage.getItem("tr_messages")||"[]");
      const unread=allMessages.filter(m=>m.to===user.email && !m.read);
      badge.textContent=unread.length||"";
      badge.style.display=unread.length>0?"inline-block":"none";
    })();
  </script>

</body>
</html>
