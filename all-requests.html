<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Requests — Trader Route</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <div class="logo"><a href="index.html">Trader Route</a></div>
    <nav>
      <a href="index.html">Home</a>
      <a href="requests.html" class="active">Requests</a>
      <a href="contact.html">Contact</a>
      <a href="pricing.html">Pricing</a>
    </nav>
  </header>

  <section class="content" style="padding: 20px 10%; min-height:80vh;">
    <h2 style="color:#007157; margin-bottom: 20px;">All Requests</h2>
    <div id="allList" class="request-list"></div>
  </section>

  <script src="assets/flag.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", async function() {
    const container = document.getElementById("allList");
    container.innerHTML = `<p style="text-align:center;color:#777;">Loading...</p>`;
    try {
      const res = await fetch("https://divine-hill-9557.traderroutee.workers.dev/requests");
      const data = await res.json();
      const today = new Date();
      const descByDate = (a,b) => (new Date(b.date) - new Date(a.date));
      const sorted = data.sort(descByDate);
      container.innerHTML = "";
      sorted.forEach(r => {
        const owner = r.ownerEmail || r.contactEmail || r.email || "";
        const isPremium = r.isPremium && r.premiumUntil && new Date(r.premiumUntil) >= today;
        const div = document.createElement("div");
        div.className = "request-card";
        div.style.border = isPremium ? "2px solid #FFD700" : "1px solid #e3e3e3";
        div.style.background = isPremium ? "#fffbe6" : "#fff";
        div.style.marginBottom = "15px";
        div.style.cursor = "pointer";
        div.onclick = () => window.location.href = `request-detail.html?id=${encodeURIComponent(r.id)}&to=${encodeURIComponent(owner)}`;
        const flagImg = `<img src="${getFlagURL(r.country, 20)}"
          alt="${r.country}" class="flag-icon-img"
          onerror="this.onerror=null;this.src='assets/flag/default.png'">`;
        const premiumBadge = isPremium ? `<span style="background:#FFD700;color:#000;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700;margin-left:8px;">⭐ Premium</span>` : "";
        div.innerHTML = `
          <h4>${r.title || "Untitled"} ${premiumBadge}</h4>
          <p>${r.description || ""}</p>
          <small>${flagImg}${r.country || "Unknown"} · ${r.category || ""} · ${new Date(r.date).toLocaleDateString('tr-TR')}</small>
        `;
        container.appendChild(div);
      });
    } catch(err) {
      container.innerHTML = `<p style="text-align:center;color:red;">Failed to load data.</p>`;
    }
  });
  </script>
</body>
</html>
